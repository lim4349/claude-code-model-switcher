#!/usr/bin/env bash
# Claude Code Model Switcher Installer

set -euo pipefail

# ============================================
# Configuration
# ============================================

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
INSTALL_DIR="${INSTALL_DIR:-$HOME/.local/bin}"
SOURCE_SCRIPT="$SCRIPT_DIR/claude-code-model-switcher.sh"
COMPLETION_DIR="$HOME/.claude-code-model-switcher"

# ============================================
# Colors
# ============================================

color_reset='\033[0m'
color_bold='\033[1m'
color_green='\033[32m'
color_blue='\033[34m'
color_yellow='\033[33m'
color_red='\033[31m'

# ============================================
# Utility Functions
# ============================================

log_info() {
    echo -e "${color_blue}ℹ${color_reset} $*"
}

log_success() {
    echo -e "${color_green}✓${color_reset} $*"
}

log_warn() {
    echo -e "${color_yellow}⚠${color_reset} $*"
}

log_error() {
    echo -e "${color_red}✗${color_reset} $*" >&2
}

# ============================================
# Installation Functions
# ============================================

check_prerequisites() {
    log_info "Checking prerequisites..."

    # Check if Claude Code is installed
    if ! command -v claude &>/dev/null && [[ ! -f "/usr/local/bin/claude" ]] && [[ ! -f "$HOME/.local/bin/claude" ]]; then
        log_warn "Claude Code not found in PATH"
        echo ""
        log_info "Install Claude Code with:"
        echo "  npm install -g @anthropic-ai/claude-code"
        echo ""
        read -p "Continue anyway? (y/N) " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            exit 1
        fi
    fi

    log_success "Prerequisites check complete"
}

create_install_dir() {
    if [[ ! -d "$INSTALL_DIR" ]]; then
        log_info "Creating install directory: $INSTALL_DIR"
        mkdir -p "$INSTALL_DIR"
    fi

    # Add to PATH if not already there
    if [[ ":$PATH:" != *":$INSTALL_DIR:"* ]]; then
        log_warn "$INSTALL_DIR is not in your PATH"
        detect_and_update_shell_config
    fi
}

detect_and_update_shell_config() {
    local shell_config=""
    local export_line="export PATH=\"\$HOME/.local/bin:\$PATH\""

    # Detect shell and config file
    if [[ -n "${ZSH_VERSION:-}" ]]; then
        shell_config="$HOME/.zshrc"
    elif [[ -n "${FISH_VERSION:-}" ]]; then
        shell_config="$HOME/.config/fish/config.fish"
        export_line="set -gx PATH \$HOME/.local/bin \$PATH"
    else
        # Default to bash
        shell_config="$HOME/.bashrc"
    fi

    # Check if export already exists
    if [[ -f "$shell_config" ]] && grep -q "$INSTALL_DIR" "$shell_config"; then
        log_success "PATH already configured in $shell_config"
        return
    fi

    log_info "Adding $INSTALL_DIR to PATH in $shell_config"

    # Create config file if it doesn't exist
    if [[ ! -f "$shell_config" ]]; then
        touch "$shell_config"
    fi

    # Add export line
    echo "" >> "$shell_config"
    echo "# Claude Code Model Switcher" >> "$shell_config"
    echo "$export_line" >> "$shell_config"

    log_success "Added to $shell_config"
    log_warn "Run 'source $shell_config' or restart your shell to use the new PATH"
}

install_main_script() {
    log_info "Installing main script..."

    cp "$SOURCE_SCRIPT" "$INSTALL_DIR/claude-model"
    chmod +x "$INSTALL_DIR/claude-model"

    log_success "Installed 'claude-model' command"
}

create_wrapper_scripts() {
    log_info "Creating wrapper scripts..."

    local aliases=("claude" "claude-glm" "claude-opus" "claude-sonnet" "claude-haiku")

    for alias in "${aliases[@]}"; do
        create_wrapper_script "$alias"
    done

    log_success "Created ${#aliases[@]} wrapper scripts"
}

create_wrapper_script() {
    local alias="$1"
    local target="$INSTALL_DIR/$alias"

    cat > "$target" << EOF
#!/usr/bin/env bash
# Wrapper for: $alias
# This file is auto-generated by claude-code-model-switcher installer

exec "$INSTALL_DIR/claude-model" use "$alias" "\$@"
EOF

    chmod +x "$target"
}

install_completions() {
    log_info "Installing shell completions..."

    mkdir -p "$COMPLETION_DIR"

    # Bash completion
    cat > "$COMPLETION_DIR/claude-model.bash" << 'EOF'
# Claude Code Model Switcher Bash Completion

_claude_model_completion() {
    local cur prev words cword
    _init_completion || return

    local commands="current list set use help"
    local aliases="claude claude-glm claude-opus claude-sonnet claude-haiku"

    case "${prev}" in
        claude-model|use|set)
            COMPREPLY=($(compgen -W "$aliases" -- "$cur"))
            ;;
        *)
            if [[ ${cword} -eq 1 ]]; then
                COMPREPLY=($(compgen -W "$commands" -- "$cur"))
            fi
            ;;
    esac
}

complete -F _claude_model_completion claude-model
complete -F _claude_model_completion claude
complete -F _claude_model_completion claude-glm
complete -F _claude_model_completion claude-opus
complete -F _claude_model_completion claude-sonnet
complete -F _claude_model_completion claude-haiku
EOF

    # Zsh completion
    cat > "$COMPLETION_DIR/claude-model.zsh" << 'EOF'
#compdef claude-model claude claude-glm claude-opus claude-sonnet claude-haiku

_claude_model() {
    local -a commands aliases
    commands=(
        'current:Show current default model'
        'list:List all available model presets'
        'set:Set default model (without running)'
        'use:Run Claude Code with specified model'
        'help:Show help message'
    )
    aliases=(
        'claude:Default (Opus 4.5)'
        'claude-glm:GLM 4.7'
        'claude-opus:Opus 4.5'
        'claude-sonnet:Sonnet 4.5'
        'claude-haiku:Haiku 4.5'
    )

    if (( CURRENT == 2 )); then
        _describe 'command' commands
    elif (( CURRENT == 3 )); then
        case ${words[2]} in
            use|set)
                _describe 'model alias' aliases
                ;;
        esac
    fi
}

_claude_model "$@"
EOF

    # Source bash completion in .bashrc if not already there
    local bashrc="$HOME/.bashrc"
    local completion_line="source \"$COMPLETION_DIR/claude-model.bash\""

    if [[ -f "$bashrc" ]] && ! grep -q "claude-model.bash" "$bashrc"; then
        echo "" >> "$bashrc"
        echo "# Claude Code Model Switcher completion" >> "$bashrc"
        echo "$completion_line" >> "$bashrc"
        log_success "Added bash completion to $bashrc"
    fi

    # Source zsh completion in .zshrc if not already there
    local zshrc="$HOME/.zshrc"
    local zsh_completion_line="fpath=('$COMPLETION_DIR' \$fpath)"

    if [[ -f "$zshrc" ]] && ! grep -q "claude-model.zsh" "$zshrc"; then
        echo "" >> "$zshrc"
        echo "# Claude Code Model Switcher completion" >> "$zshrc"
        echo "$zsh_completion_line" >> "$zshrc"
        echo "autoload -U compinit && compinit" >> "$zshrc"
        log_success "Added zsh completion to $zshrc"
    fi

    log_success "Completions installed to $COMPLETION_DIR"
}

show_post_install() {
    echo ""
    echo -e "${color_bold}${color_green}═══════════════════════════════════════════════════${color_reset}"
    echo -e "${color_bold}${color_green}  Installation Complete!${color_reset}"
    echo -e "${color_bold}${color_green}═══════════════════════════════════════════════════${color_reset}"
    echo ""
    echo -e "${color_bold}Available Commands:${color_reset}"
    echo -e "  ${color_blue}claude${color_reset}          # Run Claude Code with Opus 4.5"
    echo -e "  ${color_blue}claude-glm${color_reset}      # Run Claude Code with GLM 4.7"
    echo -e "  ${color_blue}claude-opus${color_reset}     # Run Claude Code with Opus 4.5"
    echo -e "  ${color_blue}claude-sonnet${color_reset}   # Run Claude Code with Sonnet 4.5"
    echo -e "  ${color_blue}claude-haiku${color_reset}    # Run Claude Code with Haiku 4.5"
    echo -e "  ${color_blue}claude-model${color_reset}    # Manage model settings"
    echo ""
    echo -e "${color_bold}Examples:${color_reset}"
    echo -e "  claude                    # Start with default (Opus)"
    echo -e "  claude-glm                # Start with GLM 4.7"
    echo -e "  claude-model current      # Show current model"
    echo -e "  claude-model list         # List all models"
    echo -e "  claude-model use claude-sonnet  # Use Sonnet"
    echo ""
    echo -e "${color_yellow}⚠ Note:${color_reset} Restart your shell or run 'source ~/.bashrc' (or ~/.zshrc) to apply changes."
    echo ""
}

# ============================================
# Main Installation
# ============================================

main() {
    echo ""
    echo -e "${color_bold}${color_blue}Claude Code Model Switcher Installer${color_reset}"
    echo ""

    check_prerequisites
    create_install_dir
    install_main_script
    create_wrapper_scripts
    install_completions
    show_post_install
}

main "$@"
