#!/usr/bin/env bash
# Claude Code Model Switcher wrapper
#
# Runs Claude Code against Moonshot Kimi 2.5 via an Anthropic-compatible endpoint.
# Uses `~/.claude/kimi_settings.json` by default and enables
# `--dangerously-skip-permissions` unless explicitly provided.

set -euo pipefail

SETTINGS_FILE="${CLAUDE_KIMI_SETTINGS_FILE:-$HOME/.claude/kimi_settings.json}"

_realpath() {
    if command -v realpath >/dev/null 2>&1; then
        realpath "$1"
    elif command -v readlink >/dev/null 2>&1; then
        readlink -f "$1" 2>/dev/null || echo "$1"
    else
        echo "$1"
    fi
}

_find_real_claude() {
    local self_path
    self_path="$(_realpath "$0")"

    local sibling_original
    sibling_original="$(dirname "$self_path")/claude.original"
    if [[ -x "$sibling_original" ]]; then
        if ! grep -q "Claude Code Model Switcher wrapper" "$sibling_original" 2>/dev/null; then
            echo "$sibling_original"
            return 0
        fi
    fi

    # PRIORITIZE standalone installer (always latest version)
    local standalone="$HOME/.local/bin/claude"
    if [[ -x "$standalone" && "$(_realpath "$standalone")" != "$self_path" ]]; then
        echo "$standalone"
        return 0
    fi

    # Then check npm global installation
    if command -v npm >/dev/null 2>&1; then
        local npm_prefix
        npm_prefix="$(npm prefix -g 2>/dev/null || true)"
        if [[ -n "${npm_prefix:-}" && -x "$npm_prefix/bin/claude" ]]; then
            echo "$npm_prefix/bin/claude"
            return 0
        fi
    fi

    # Finally search PATH
    local IFS=':'
    local dir
    for dir in $PATH; do
        [[ -n "$dir" ]] || continue
        [[ "$dir" == "$HOME/.local/bin" ]] && continue  # already checked above
        local candidate="$dir/claude"
        if [[ -x "$candidate" ]]; then
            if [[ "$(_realpath "$candidate")" != "$self_path" ]]; then
                echo "$candidate"
                return 0
            fi
        fi
    done

    return 1
}

have_danger=false
have_settings=false
for arg in "$@"; do
    case "$arg" in
        --dangerously-skip-permissions|--dangerously-skip-permissions=*)
            have_danger=true
            ;;
        --settings)
            have_settings=true
            ;;
        --settings=*)
            have_settings=true
            ;;
    esac
done

if [[ "$have_settings" == false ]]; then
    if [[ ! -f "$SETTINGS_FILE" ]]; then
        echo "✗ Settings file not found: $SETTINGS_FILE" >&2
        echo "  Run: claude-model config kimi  (or: claude-model setup)" >&2
        echo "  See: README.md (Setup section)" >&2
        exit 1
    fi
fi

claude_bin="$(_find_real_claude || true)"
if [[ -z "${claude_bin:-}" || ! -x "$claude_bin" ]]; then
    echo "✗ Claude Code not found. Install with: npm install -g @anthropic-ai/claude-code" >&2
    exit 1
fi

# Read config for auto dangerous mode
CONFIG_FILE="${CLAUDE_CONFIG_DIR:-$HOME/.claude}/.model-switcher-config"
AUTO_DANGEROUS_MODE="false"
if [[ -f "$CONFIG_FILE" ]]; then
    # shellcheck disable=SC1090
    source "$CONFIG_FILE" 2>/dev/null || true
fi

extra_args=()
if [[ "$have_danger" == false && "$AUTO_DANGEROUS_MODE" == "true" ]]; then
    extra_args+=(--dangerously-skip-permissions)
fi
if [[ "$have_settings" == false ]]; then
    extra_args+=(--settings "$SETTINGS_FILE")
fi

exec "$claude_bin" "${extra_args[@]}" "$@"
